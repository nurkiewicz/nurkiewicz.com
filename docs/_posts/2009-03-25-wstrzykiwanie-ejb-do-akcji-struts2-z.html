---
layout: post
title: Wstrzykiwanie EJB do akcji Struts2 z @EJB
date: '2009-03-25T22:19:00.010+01:00'
author: Tomasz Nurkiewicz
tags:
- ejb
- struts2
- spring
modified_time: '2009-03-28T22:17:13.160+01:00'
thumbnail: http://1.bp.blogspot.com/_P3ewsGQzHn0/Scqkem2aRuI/AAAAAAAAAMk/l_YB1Othy-4/s72-c/dateserver.png
blogger_id: tag:blogger.com,1999:blog-6753769565491687768.post-9101958322435720033
blogger_orig_url: https://www.nurkiewicz.com/2009/03/wstrzykiwanie-ejb-do-akcji-struts2-z.html
---

Chciałbym dzisiaj pokazać niekoniecznie odkrywczy, ale dość ciekawy przykład integracji frameworku Struts2  z EJB3 - a wszystko sklejone za pomocą Springa. Tytuł posta jest bowiem tendencyjny: EJB można wstrzykiwać do dowolnych beanów Springowych, ale skupimy się na akcjach Struts2.<br /><br />Przyjmijmy, że w naszej aplikacji istnieje EJB z lokalnym interfejsem <span style="font-family:courier new;">DateServiceLocal</span>:<br /><pre name="code" class="java">@Local<br />public interface DateServiceLocal {<br />String getCurrentDate(Locale locale, TimeZone timeZone);<br />}</pre><br />Usługa prosta, zwraca bieżący czas w podanej strefie czasowej, uwzględniając lokalizację (np. czas w Australii po rosyjsku). Z drugiej strony chcemy skorzystać z tej usługi w akcji Struts2. Jednak brzydzi nas (anty)wzorzec Service Locator, a tym bardziej szastanie na prawo i lewo klasą <span style="font-family:courier new;">InitialContext</span>. Mamy XXI wiek, "<span style="font-style: italic;">don't call me, I'll call you</span>" głosi hasło reklamowe wzorca Dependency Injection. Nasza akcja powinna wyglądać tak:<br /><pre name="code" class="java"><br />public class DateAction extends ActionSupport {<br /><br />@EJB<br />private DateServiceLocal dateService;<br />private Locale language;<br />private TimeZone timeZone;<br /><br />public String execute() throws Exception {<br /> addActionMessage(dateService.getCurrentDate(language, timeZone));<br /> return SUCCESS;<br />}<br /><br />/*...*/<br />}<br /></pre><br /><br />Mamy pole oznaczone standardową adnotacją <span style="font-family:courier new;">@EJB</span> (uwaga: <span style="font-weight: bold;">nie </span>potrzebuje settera) oraz pola <span style="font-family:courier new;">language </span>i <span style="font-family:courier new;">timeZone </span>pochodzące z formularza. Potem w <span style="font-family:courier new;">execute()</span> najzwyczajniej w świecie wołamy metodę lokalnego interfejsu naszego EJB. To wszystko! Jak przygotować środowisko do tak wygodnej integracji?<br /><br />Przede wszystkim przygotowujemy aplikację Struts2 zintegrowaną ze Springiem (cyklem życia akcji ma zarządzać kontener IoC). Jak to zrobić, już pokazywałem, chociażby w artykule "<a href="http://nurkiewicz.blogspot.com/2009/01/elegancki-crud-w-jednej-akcji-struts2.html">Elegancki CRUD w jednej akcji Struts2</a>". Następnie tworzymy springowe proxy odwołujące się do wskazanego EJB. Jeśli nigdy nie korzystaliście z tej funkcji: Spring tworzy specjalne proxy, które z jednej strony zachowuje się jak zwykły bean springowy, jednak w rzeczywistości deleguje wszystkie wywołania do wskazanego EJB. Dzięki zastosowani przestrzeni nazw <span style="font-family:courier new;">jee </span>wystarczy wpisać:<br /><br /><pre name="code" class="xml"><br />&lt;jee:local-slsb<br />id="dateService"<br />jndi-name="dateserver-ear-${project.version}/DateService/local"<br />business-interface="com.blogspot.nurkiewicz.dateserver.DateServiceLocal"/><br /></pre><br /><br />Przykład testowałem na JBossie 5.0.1, który poprzedza nazwy JNDI nazwą EARa zawierającego EJB-JAR. A ponieważ maven domyślnie dokleja wersję do nazwy artefaktu ear (<span style="font-family:courier new;">dateserver-ear-0.0.1-SNAPSHOT.ear</span>, i radzę tego nie zmieniać), należy przefiltrować plik <span style="font-family:courier new;">applicationContext.xml</span> i wkleić doń aktualną wersję. Naturalnie zahardkodowanie <span style="font-family:courier new;">0.0.1-SNAPSHOT</span> to kiepski pomysł :-).<br /><br />Od tej chwili mamy już bean springowy o id <span style="font-family:courier new;">dateService</span>, a w rzeczywistości proxy do EJB. Jeśli spodziewacie się teraz deklaratywnego wstrzykiwania tego beanu do odpowiednich akcji to muszę Was zawieźć... Nic więcej robić nie trzeba! No, prawie. Poniższy wpis sprawi, że Spring przeszuka wszystkie właściwości nowotworzonych beanów i będą oznaczone adnotacją <span style="font-family:courier new;">@EJB</span>, automatycznie wstrzyknie pasujący bean/EJB:<br /><br /><pre name="code" class="xml"><br />&lt;bean class="org.springframework.context.annotation.CommonAnnotationBeanPostProcessor"/><br /></pre><br /><br />Nawiasem mówiąc ten post procesor (zachęcam do pisania własnych post procesorów, to naprawdę potężny mechanizm!) rozpoznaje również adnotacje <span style="font-family:courier new;">javax.annotation.PostConstruct</span> i <span style="font-family:courier new;">PreDestroy </span>- również używam ich w tej aplikacji.<br /><br />Ot, cała filozofia. Od tej pory możemy się cieszyć bardzo wygodną integracją frameworku webowego Struts2 z back-endem w EJB3. A wszystko to spaja - o zgrozo - największy rywal EJB, czyli Spring. Może zatem, zamiast się gryźć, próbujmy połączyć te dwa żywioły?<br /><br /><a href="http://sites.google.com/site/nurkiewicz/Home/zalaczniki/dateserver.zip">Tutaj</a> dostępny kod źródłowy przykładowej aplikacji (maven friendly). Podzieliłem ją na cztery artefakty: <span style="font-family:courier new;">ejb-api</span> (interfejs EJB), <span style="font-family:courier new;">ejb</span>, <span style="font-family:courier new;">web </span>i <span style="font-family:courier new;">ear</span>. Jest to dodatkowy zysk z EJB: bardzo wyraźny podział widoku i logiki biznesowej, punktem styku są jedynie interfejsy komponentów sesyjnych. Do potestowania wystarczy <span style="font-family:courier new;">mvn package</span> i wdrożenie na JBossie. A na koniec obiecany czas w Australii po rosyjsku - jak na aplikację testową całkiem przydatna funkcjonalność ;-). U nich już jutrzejszy poranek, a w Polsce pora iść spać. Dobrej nocy!<br /><br /><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://1.bp.blogspot.com/_P3ewsGQzHn0/Scqkem2aRuI/AAAAAAAAAMk/l_YB1Othy-4/s1600-h/dateserver.png"><img style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer; width: 200px; height: 105px;" src="http://1.bp.blogspot.com/_P3ewsGQzHn0/Scqkem2aRuI/AAAAAAAAAMk/l_YB1Othy-4/s200/dateserver.png" alt="" id="BLOGGER_PHOTO_ID_5317243155796084450" border="0" /></a>