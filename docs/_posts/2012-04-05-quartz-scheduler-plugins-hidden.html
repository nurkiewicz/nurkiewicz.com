---
layout: post
title: Quartz scheduler plugins - hidden treasure
date: '2012-04-05T13:57:00.000+02:00'
author: Tomasz Nurkiewicz
tags:
- quartz
modified_time: '2012-04-06T00:02:37.744+02:00'
blogger_id: tag:blogger.com,1999:blog-6753769565491687768.post-2663945565741401978
blogger_orig_url: https://www.nurkiewicz.com/2012/04/quartz-scheduler-plugins-hidden.html
---

Although briefly described in the official documentation, I believe <a href="http://quartz-scheduler.org/documentation/quartz-2.1.x/configuration/ConfigPlugins">Quartz plugins</a> aren't known enough, looking at how useful they are.<br /><br />Essentially plugins in Quartz are convenient classes wrapping registration of underlying <a href="http://quartz-scheduler.org/documentation/quartz-2.1.x/configuration/ConfigListeners">listeners</a>.  You are free to write your own plugins but we will focus on existing ones shipped with Quartz.  <br /><h4>  <code>LoggingTriggerHistoryPlugin</code></h4>First some background. Two main abstractions in Quartz are jobs and triggers. Job is a piece of code that we would like to schedule. Trigger instructs the scheduler when this code should run. CRON (e.g. <i>run every Friday between 9 AM and 5 PM until November</i>) and simple (<i>run 100 times every 2 hours</i>) triggers are most commonly used. You associate any number of triggers to a single job.<br /><br />Believe it or not, Quartz  by default provides <b>no logging</b> or monitoring whatsoever of executed jobs and triggers. There is an API, but no built-in logging is implemented. It won't show you that it now executes this particular job due to this trigger firing. So the first thing you should do is adding the following lines to your <code>quartz.properties</code>:<br /><a name='more'></a><br /><pre class="brush: plain; highlight: 1">org.quartz.plugin.triggerHistory.class=org.quartz.plugins.history.LoggingTriggerHistoryPlugin<br /><br />org.quartz.plugin.triggerHistory.triggerFiredMessage=Trigger [{1}.{0}] fired job [{6}.{5}] scheduled at: {2, date, dd-MM-yyyy HH:mm:ss.SSS}, next scheduled at: {3, date, dd-MM-yyyy HH:mm:ss.SSS}<br /><br />org.quartz.plugin.triggerHistory.triggerCompleteMessage=Trigger [{1}.{0}] completed firing job [{6}.{5}] with resulting trigger instruction code: {9}. Next scheduled at: {3, date, dd-MM-yyyy HH:mm:ss.SSS}<br /><br />org.quartz.plugin.triggerHistory.triggerMisfiredMessage=Trigger [{1}.{0}] misfired job [{6}.{5}]. Should have fired at: {3, date, dd-MM-yyyy HH:mm:ss.SSS}<br /></pre>The first line (and the only required) loads the plugin class <a href="http://quartz-scheduler.org/api/2.1.0/org/quartz/plugins/history/LoggingTriggerHistoryPlugin.html"><code>LoggingTriggerHistoryPlugin</code></a>. The remaining lines are configuring the plugin, customizing the logging messages. I found the built-in defaults not very well thought, e.g. they display current time which is already part of the logging framework message. You are free to construct any logging message, see the API for details. Adding these extra few lines makes debugging and monitoring much easier:  <br /><pre class="brush: plain">LoggingTriggerHistoryPlugin | Trigger [Demo.Every-few-seconds] fired job [Demo.Print-message] scheduled at:  04-04-2012 23:23:47.036, next scheduled at:  04-04-2012 23:23:51.036<br />//...job output<br />LoggingTriggerHistoryPlugin | Trigger [Demo.Every-few-seconds] completed firing job [Demo.Print-message] with resulting trigger instruction code: DO NOTHING. Next scheduled at:  04-04-2012 23:23:51.036<br /></pre>You see now why naming your triggers (<code>Demo.Every-few-seconds</code>) and jobs (<code>Demo.Print-message</code>) is so important.   <br /><h4>  <code>LoggingJobHistoryPlugin</code></h4>There is another handy plugin related to logging:  <br /><pre class="brush: plain; highlight: 1">org.quartz.plugin.jobHistory.class=org.quartz.plugins.history.LoggingJobHistoryPlugin<br />org.quartz.plugin.jobHistory.jobToBeFiredMessage=Job [{1}.{0}] to be fired by trigger [{4}.{3}], re-fire: {7}<br />org.quartz.plugin.jobHistory.jobSuccessMessage=Job [{1}.{0}] execution complete and reports: {8}<br />org.quartz.plugin.jobHistory.jobFailedMessage=Job [{1}.{0}] execution failed with exception: {8}<br />org.quartz.plugin.jobHistory.jobWasVetoedMessage=Job [{1}.{0}] was vetoed. It was to be fired by trigger [{4}.{3}] at: {2, date, dd-MM-yyyy HH:mm:ss.SSS}<br /></pre>The rule is the same - plugin + extra configuration. See <a href="http://quartz-scheduler.org/api/2.1.0/org/quartz/plugins/history/LoggingJobHistoryPlugin.html">JavaDoc of <code>LoggingJobHistoryPlugin</code></a> for details and possible placeholders. Quick look at logs reveals very descriptive output:  <br /><pre class="brush: plain">Trigger [Demo.Every-few-seconds] fired job [Demo.Print-message] scheduled at:  04-04-2012 23:34:53.739, next scheduled at:  04-04-2012 23:34:57.739<br />Job [Demo.Print-message] to be fired by trigger [Demo.Every-few-seconds], re-fire: 0<br />//...job output<br />Job [Demo.Print-message] execution complete and reports: null<br />Trigger [Demo.Every-few-seconds] completed firing job [Demo.Print-message] with resulting trigger instruction code: DO NOTHING. Next scheduled at:  04-04-2012 23:34:57.739<br /></pre>I have no idea why these plugins aren't enabled by default. After all, if you don't want such a verbose output, you can turn it off in your logging framework. Never mind, I think it is a good idea to have them in place when troubleshooting Quartz execution.  <br /><h4>  <code>XMLSchedulingDataProcessorPlugin</code></h4>This is a pretty comprehensive plugin. It reads XML file (by default named <code>quartz_data.xml</code>) containing jobs and triggers definitions and adds them to the scheduler. This is especially useful when you have a global job that you need to add once. Plugin can either update the existing jobs/triggers or ignore the XML file if they already exist - very useful when <a href="http://nurkiewicz.com/2012/04/configuring-quartz-with-jdbcjobstore-in.html">JDBCJobStore</a> is used.  <br /><pre class="brush: plain">org.quartz.plugin.xmlScheduling.class=org.quartz.plugins.xml.XMLSchedulingDataProcessorPlugin</pre>In the aforementioned article we have been manually adding job to the scheduler:  <br /><pre class="brush: scala">val trigger = newTrigger().<br />        withIdentity("Every-few-seconds", "Demo").<br />        withSchedule(<br />            simpleSchedule().<br />                    withIntervalInSeconds(4).<br />                    repeatForever()<br />        ).<br />        build()<br /> <br />val job = newJob(classOf[PrintMessageJob]).<br />        withIdentity("Print-message", "Demo").<br />        usingJobData("msg", "Hello, world!").<br />        build()<br /> <br />scheduler.scheduleJob(job, trigger)<br /></pre>The same can be achieved with XML configuration, just place the following <code>quartz_data.xml</code> in your CLASSPATH:  <br /><pre class="brush: xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;<br />&lt;job-scheduling-data xmlns="http://www.quartz-scheduler.org/xml/JobSchedulingData"<br />                     xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br />                     xsi:schemaLocation=" http://www.quartz-scheduler.org/xml/JobSchedulingData http://www.quartz-scheduler.org/xml/job_scheduling_data_2_0.xsd "&gt;<br /><br />    &lt;processing-directives&gt;<br />        &lt;overwrite-existing-data&gt;false&lt;/overwrite-existing-data&gt;<br />        &lt;ignore-duplicates&gt;true&lt;/ignore-duplicates&gt;<br />    &lt;/processing-directives&gt;<br /><br />    &lt;schedule&gt;<br />        &lt;trigger&gt;<br />            &lt;simple&gt;<br />                &lt;name&gt;Every-few-seconds&lt;/name&gt;<br />                &lt;group&gt;Demo&lt;/group&gt;<br />                &lt;job-name&gt;Print-message&lt;/job-name&gt;<br />                &lt;job-group&gt;Demo&lt;/job-group&gt;<br />                &lt;repeat-count&gt;-1&lt;/repeat-count&gt;<br />                &lt;repeat-interval&gt;4000&lt;/repeat-interval&gt;<br />            &lt;/simple&gt;<br />        &lt;/trigger&gt;<br /><br />        &lt;job&gt;<br />            &lt;name&gt;Print-message&lt;/name&gt;<br />            &lt;group&gt;Demo&lt;/group&gt;<br />            &lt;job-class&gt;com.blogspot.nurkiewicz.quartz.demo.PrintMessageJob&lt;/job-class&gt;<br />            &lt;job-data-map&gt;<br />                &lt;entry&gt;<br />                    &lt;key&gt;msg&lt;/key&gt;<br />                    &lt;value&gt;Hello, World!&lt;/value&gt;<br />                &lt;/entry&gt;<br />            &lt;/job-data-map&gt;<br />        &lt;/job&gt;<br /><br />    &lt;/schedule&gt;<br /><br /><br />&lt;/job-scheduling-data&gt;<br /></pre>The file supports both simple and CRON triggers and is well <a href="http://www.quartz-scheduler.org/xml/job_scheduling_data_2_0.xsd">described using XML Schema</a>.  It is even possible to point out to an XML files somewhere in the file system and periodically scan them for changes (!) (see: <a href="http://quartz-scheduler.org/api/2.0.0/org/quartz/plugins/xml/XMLSchedulingDataProcessorPlugin.html#setScanInterval(long)"><code>XMLSchedulingDataProcessorPlugin.setScanInterval()</code></a>. Guess what is Quartz using to schedule periodic scanning?   <br /><pre class="brush: plain">org.quartz.plugin.xmlScheduling.fileNames=/etc/quartz/system-jobs.xml,/home/johnny/my-jobs.xml<br />org.quartz.plugin.xmlScheduling.scanInterval=60<br /></pre><h4>  <code>ShutdownHookPlugin</code></h4>Last but not least, <a href="http://quartz-scheduler.org/api/2.1.0/org/quartz/plugins/management/ShutdownHookPlugin.html"><code> ShutdownHookPlugin</code></a>. Small but probably useful plugin that register shutdown hook in the JVM in order to gently stop the scheduler. However I recommend turning <code>cleanShutdown</code> off - if the system already tries to abruptly stop the application (typically scheduler shutdown is called by Spring via <code>SchedulerFactoryBean</code>) or the user hit <kbd>Ctrl</kbd>+<kbd>C</kbd> - waiting for currently running jobs seems like a bad idea. After all, maybe we are killing the application <i>because</i> some jobs are running for too long/hunging?  <br /><pre class="brush: plain">org.quartz.plugin.shutdownHook.class=org.quartz.plugins.management.ShutdownHookPlugin<br />org.quartz.plugin.shutdownHook.cleanShutdown=false<br /></pre>As you can see Qurtz ships with few quite interesting plugins. For some reason they aren't described in detail in the official documentation, but they work pretty well and are a valuable addition to scheduler.<br/><br/><a href="https://github.com/nurkiewicz/quartz-demo">The source code with applied plugins</a> is available on GitHub.